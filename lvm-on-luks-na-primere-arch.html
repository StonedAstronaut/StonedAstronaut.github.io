<!DOCTYPE html>
<html lang="en">
<head>
        <title>Astro blog : LVM on LUKS на примере arch</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://stonedastronaut.github.io/theme/css/main.css" type="text/css" />
        <link href="https://stonedastronaut.github.io/" type="application/atom+xml" rel="alternate" title="Astro blog ATOM Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://stonedastronaut.github.io/css/ie.css"/>
                <script src="https://stonedastronaut.github.io/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="https://stonedastronaut.github.io/css/ie6.css"/><![endif]-->

</head>

<body>
        
<header>
    <h1><a href="https://stonedastronaut.github.io/lvm-on-luks-na-primere-arch.html" id="page-title">LVM on LUKS на примере arch</a></h1>
    <span id="sitename"><a href="https://stonedastronaut.github.io" id="site-title">Astro blog </a> &sdot;</span>
<time datetime="2015-07-26T03:53:00+06:00">Sun 26 July 2015</time></header>
<article>
    <hr />
<h2>Создаём разделы физические</h2>
<p>Вот такая структура диска.</p>
<ul>
<li>
<p><code>/dev/sda1 -&gt; /boot</code></p>
</li>
<li>
<p><code>/dev/sda2 -&gt; LVM</code></p>
</li>
</ul>
<h3>Шифруем раздел LVM</h3>
<div class="highlight"><pre>cryptsetup luksFormat -c aes-xts-plain64 -s <span class="m">512</span> /dev/sda2
</pre></div>


<p>больше о параметрах шифрования см. <a href="https://wiki.archlinux.org/index.php/Dm-crypt/Device_encryption#Encryption_options_for_LUKS_mode">здесь</a></p>
<div class="highlight"><pre>cryptsetup open --type luks /dev/sda2 lvm
</pre></div>


<h3>Создаём разделы на LVM</h3>
<p>создаём физический раздел LVM:</p>
<div class="highlight"><pre>pvcreate /dev/mapper/lvm
</pre></div>


<p>создаём группу разделов LVM:</p>
<div class="highlight"><pre>vgcreate MyStorage /dev/mapper/lvm
</pre></div>


<p>создаём логические разделы LVM:</p>
<div class="highlight"><pre>lvcreate -L 8G MyStorage -n swapvol
lvcreate -L 15G MyStorage -n rootvol
lvcreate -l +100%FREE MyStorage -n homevol
</pre></div>


<p>форматируем разделы:</p>
<div class="highlight"><pre>mkfs.ext4 /dev/mapper/MyStorage-rootvol
mkfs.ext4 /dev/mapper/MyStorage-homevol
mkswap /dev/mapper/MyStorage-swapvol
</pre></div>


<p>наконец-то монтируем</p>
<div class="highlight"><pre>mount /dev/MyStorage/rootvol /mnt
mkdir /mnt/home
mount /dev/MyStorage/homevol /mnt/home
swapon /dev/MyStorage/swapvol
</pre></div>


<h3>подготавливаем boot</h3>
<div class="highlight"><pre>mkfs.ext2 /dev/sda1
mkdir /mnt/boot
mount /dev/sda1 /mnt/boot
</pre></div>


<p>Дальше идёт обычная установка системы, до момента генерации <strong>initramfs</strong>.</p>
<p>Для того, что бы можно было загружаться с lvm надо добавить в <code>/etc/mkinitcpio.conf</code>:</p>
<div class="highlight"><pre>/etc/mkinitcpio.conf:
<span class="nv">HOOKS</span><span class="o">=</span><span class="s2">&quot;... encrypt lvm2 resume ... filesystems ...&quot;</span>
</pre></div>


<p><strong>encrypted</strong>, <strong>lvm2</strong> и <strong>resume</strong> должны стоять перед <strong>filesystems</strong></p>
<h3>конфигурация загрузчика</h3>
<p>Перед генерацией конфига <em>grub</em>, необходимо добавить информацию о зашифрованных разделах в <code>/etc/default/grub</code>:</p>
<div class="highlight"><pre>...
<span class="nv">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="o">=</span><span class="s2">&quot;quiet resume=/dev/MyStorage/swapvol&quot;</span>
<span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;cryptdevice=/dev/sda2:MyStorage \</span>
<span class="s2">root=/dev/mapper/MyStorage-rootvol&quot;</span>
...
</pre></div>


<p>Собственно всё.</p>
<p><a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#LUKS_on_LVM">ссылка на оригинал</a></p>
</article>

        <footer>
            <nav>
                <ul>
                    <li><a href="https://stonedastronaut.github.io/pages/about.html">About</a></li>
                    <li>:: <a href="https://stonedastronaut.github.io/tags.html">Tags</a></li>
                </ul>
            </nav>
                <p id="theme-credit">Proudly powered by <a href="http://docs.notmyidea.org/alexis/pelican/">pelican</a></p>
        </footer>

</body>
</html>